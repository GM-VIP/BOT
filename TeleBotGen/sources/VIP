#!/bin/bash

vipdb="/etc/ADM-db/VIP-database.json"
grupo_log="-1001475120970"

vip_autoregistro () {
    [[ ! -e $vipdb ]] && echo "[]" > "$vipdb"

    # Buscar si ya existe el usuario
    existente=$(jq -r ".[] | select(.id == \"$chatuser\")" "$vipdb")

    # Preparar nueva entrada
    nuevo=$(jq -n --arg id "$chatuser" \
                   --arg nombre "$message_from_first_name" \
                   --arg usuario "$message_from_username" \
                   --arg fecha "$(date '+%Y-%m-%d')" \
                   '{id: $id, nombre: $nombre, usuario: $usuario, fecha: $fecha}')

    if [[ -z "$existente" ]]; then
        # ğŸ“Œ NUEVO USUARIO
        json=$(jq ". += [$nuevo]" "$vipdb")
        echo "$json" > "$vipdb"

        notificacion="ğŸ“¥ <b>Nuevo usuario VIP registrado</b>\n\nğŸ†” ID: <code>$chatuser</code>\nğŸ‘¤ Nombre: <b>$message_from_first_name</b>\nğŸ”° Usuario: @$message_from_username\nğŸ“… Fecha: $(date '+%Y-%m-%d')"

    else
        # ğŸ“Œ USUARIO EXISTENTE: verificar cambios
        nombre_viejo=$(echo "$existente" | jq -r '.nombre')
        usuario_viejo=$(echo "$existente" | jq -r '.usuario')

        cambios=""
        [[ "$nombre_viejo" != "$message_from_first_name" ]] && cambios+="ğŸ“ <b>Nombre actualizado:</b>\nDe: <code>$nombre_viejo</code>\nA: <code>$message_from_first_name</code>\n\n"
        [[ "$usuario_viejo" != "$message_from_username" ]] && cambios+="ğŸ”„ <b>Usuario actualizado:</b>\nDe: @$usuario_viejo\nA: @$message_from_username\n\n"

        if [[ -n "$cambios" ]]; then
            json=$(jq "del(.[] | select(.id == \"$chatuser\"))" "$vipdb")
            echo "$json" | jq ". += [$nuevo]" > "$vipdb"

            notificacion="ğŸ”§ <b>Usuario VIP actualizado</b>\nğŸ†” ID: <code>$chatuser</code>\n\n$cambiosğŸ“… Fecha: $(date '+%Y-%m-%d')"
        fi
    fi

    # Enviar notificaciÃ³n si hubo algo nuevo o modificado
    if [[ -n "$notificacion" ]]; then
        ShellBot.sendMessage --chat_id "$grupo_log" \
                             --text "$notificacion" \
                             --parse_mode html
    fi
}
